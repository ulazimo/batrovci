<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soccer Match-3: Liverpool Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden;
            touch-action: manipulation;
        }

        .tile {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.15s, top 0.2s ease-in, left 0.15s ease-out;
            cursor: pointer;
            position: absolute;
            width: 14.28%; 
            aspect-ratio: 1/1;
            z-index: 1;
            padding: 3px;
        }

        .tile-inner {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .booster-rocket::after {
            content: '';
            position: absolute;
            inset: -2px;
            border: 2px dashed white;
            border-radius: 10px;
            animation: rotate 4s linear infinite;
        }

        .booster-bomb {
            filter: saturate(2) brightness(1.2);
            box-shadow: 0 0 15px currentColor;
            animation: pulse-glow 1s ease-in-out infinite alternate;
        }

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse-glow { from { transform: scale(1); filter: brightness(1); } to { transform: scale(1.05); filter: brightness(1.5); } }

        .selected .tile-inner {
            outline: 3px solid white;
            outline-offset: -3px;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255,255,255,0.4);
            z-index: 10;
        }

        .grid-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            background: rgba(255, 255, 255, 0.03);
            padding: 4px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .stats-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            transition: transform 0.2s;
        }

        .progress-bar {
            height: 4px;
            border-radius: 2px;
            background: #334155;
            overflow: hidden;
        }

        .goal-anim { animation: goalScale 0.6s ease-in-out; }
        @keyframes goalScale { 0% { transform: scale(1); } 50% { transform: scale(1.3); color: #22c55e; } 100% { transform: scale(1); } }

        .stat-indicator {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 800;
            font-size: 14px;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            z-index: 50;
        }

        @keyframes floatUp { 0% { transform: translate(-50%, 0); opacity: 1; } 100% { transform: translate(-50%, -30px); opacity: 0; } }

        .bg-attack { background-color: #ef4444; } 
        .bg-defense { background-color: #3b82f6; }
        .bg-pass { background-color: #22c55e; }
        .bg-stamina { background-color: #eab308; }
        
        #sim-logs::-webkit-scrollbar { width: 4px; }
        #sim-logs::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }

        .view-hidden { display: none !important; }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
        }

        /* Bottom Nav Styles */
        .bottom-nav {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-btn.active {
            color: #ef4444;
        }

        /* Transition Overlay */
        #transition-overlay {
            background: #0f172a;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }
        #transition-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen pb-16">

    <!-- TRANSITION OVERLAY -->
    <div id="transition-overlay" class="fixed inset-0 flex items-center justify-center">
        <div class="text-center">
            <h2 class="text-4xl font-black italic uppercase tracking-tighter text-red-600 animate-pulse">Match Day</h2>
            <p class="text-xs uppercase tracking-widest text-slate-500 mt-2">Entering Anfield...</p>
        </div>
    </div>

    <!-- LEAGUE STANDINGS VIEW -->
    <div id="view-standings" class="w-full max-w-md h-[90vh] flex flex-col p-4">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-black italic uppercase tracking-tighter text-red-600">Standings</h1>
            <div class="text-right">
                <div class="text-[10px] uppercase text-slate-500 font-bold">Season Progress</div>
                <div class="text-lg font-bold" id="league-round-display">Round 1 / 18</div>
            </div>
        </div>

        <div class="flex-1 bg-slate-900/50 rounded-2xl border border-white/5 overflow-hidden flex flex-col mb-4">
            <div class="grid grid-cols-9 gap-1 p-3 bg-slate-800/50 text-[9px] font-bold uppercase tracking-widest text-slate-400">
                <div class="col-span-1">#</div>
                <div class="col-span-3">Team</div>
                <div class="col-span-1 text-center">MP</div>
                <div class="col-span-1 text-center">W</div>
                <div class="col-span-1 text-center">D</div>
                <div class="col-span-1 text-center">GD</div>
                <div class="col-span-1 text-center">PTS</div>
            </div>
            <div id="standings-list" class="flex-1 overflow-y-auto">
                <!-- Teams injected here -->
            </div>
        </div>

        <button id="btn-play-match" onclick="startMatchPreparation()" class="w-full bg-red-600 hover:bg-red-500 py-4 rounded-xl font-black uppercase tracking-widest shadow-lg transition-transform active:scale-95 mb-4">
            Next Match: <span id="next-opp-label">---</span>
        </button>
    </div>

    <!-- PUZZLE VIEW -->
    <div id="view-puzzle" class="w-full max-w-md h-[90vh] flex flex-col p-4 relative view-hidden">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-2xl font-bold uppercase tracking-tighter italic leading-none text-red-500">Match Prep</h1>
                <p class="text-xs text-slate-400 mt-1 uppercase tracking-wider">Moves: <span id="moves-count" class="text-white font-bold text-lg">15</span></p>
            </div>
            <div class="flex flex-col items-end gap-1">
                <div class="flex gap-2">
                     <button onclick="triggerMatchTransition()" class="bg-blue-600 text-white text-[10px] px-2 py-1 rounded font-bold uppercase shadow-lg hover:bg-blue-500">Skip to Match</button>
                     <button onclick="showTutorial()" class="w-7 h-7 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold hover:bg-slate-600 transition-colors shadow-lg border border-white/10">?</button>
                </div>
                <div class="text-right">
                    <div class="text-[10px] uppercase text-slate-500 font-bold">Opponent</div>
                    <div id="puzzle-opp-name" class="text-lg font-bold text-blue-500 italic leading-none uppercase">---</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-4 gap-2 mb-4">
            <div class="stats-card p-2 rounded-xl text-center border-b-4 border-red-500" id="card-attack">
                <div class="text-[8px] uppercase text-slate-400 font-bold">Attack</div>
                <div id="hero-atk" class="text-lg font-bold">10</div>
                <div class="progress-bar mt-1"><div id="bar-attack" class="h-full bg-red-500 transition-all" style="width: 10%"></div></div>
            </div>
            <div class="stats-card p-2 rounded-xl text-center border-b-4 border-green-500" id="card-pass">
                <div class="text-[8px] uppercase text-slate-400 font-bold">Pass</div>
                <div id="hero-mid" class="text-lg font-bold">10</div>
                <div class="progress-bar mt-1"><div id="bar-pass" class="h-full bg-green-500 transition-all" style="width: 10%"></div></div>
            </div>
            <div class="stats-card p-2 rounded-xl text-center border-b-4 border-blue-500" id="card-defense">
                <div class="text-[8px] uppercase text-slate-400 font-bold">Defense</div>
                <div id="hero-def" class="text-lg font-bold">10</div>
                <div class="progress-bar mt-1"><div id="bar-defense" class="h-full bg-blue-500 transition-all" style="width: 10%"></div></div>
            </div>
            <div class="stats-card p-2 rounded-xl text-center border-b-4 border-yellow-500" id="card-stamina">
                <div class="text-[8px] uppercase text-slate-400 font-bold">Stamina</div>
                <div id="hero-stam" class="text-lg font-bold">10</div>
                <div class="progress-bar mt-1"><div id="bar-stamina" class="h-full bg-yellow-500 transition-all" style="width: 10%"></div></div>
            </div>
        </div>

        <div id="board" class="grid-container mb-4"></div>
    </div>

    <!-- SIMULATION VIEW -->
    <div id="view-sim" class="w-full max-w-md h-[90vh] flex flex-col p-6 view-hidden">
        <h2 class="text-xl font-black mb-4 uppercase italic tracking-tighter text-blue-500 text-center">Live Match Engine</h2>
        <div class="w-full flex justify-between items-center mb-6 bg-slate-900/80 p-4 rounded-2xl border border-white/5 shadow-xl">
            <div class="text-center">
                <div class="w-12 h-12 bg-red-700 rounded-xl flex items-center justify-center mb-1 border border-red-400/30 font-black shadow-lg">LFC</div>
                <div class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Home</div>
            </div>
            <div class="text-4xl font-black italic flex gap-3">
                <span id="score-home">0</span>
                <span class="text-slate-700">:</span>
                <span id="score-away">0</span>
            </div>
            <div class="text-center">
                <div id="opp-crest" class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center mb-1 border border-white/10 font-black shadow-lg text-xs uppercase">
                    <span id="opp-initials">OPP</span>
                </div>
                <div class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Away</div>
            </div>
        </div>
        <div id="sim-logs" class="w-full bg-slate-950 rounded-2xl p-4 flex-1 overflow-y-auto space-y-5 border border-slate-800 shadow-inner mb-2"></div>
        <button id="finish-match-btn" class="w-full bg-red-600 py-4 rounded-xl font-black uppercase tracking-widest view-hidden transition-transform active:scale-95 shadow-lg">Finish Match Day</button>
    </div>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 left-0 right-0 h-16 bottom-nav flex items-center justify-around z-50">
        <button onclick="switchView('view-standings')" id="nav-standings" class="nav-btn flex flex-col items-center gap-1 active">
            <span class="text-xl">üìä</span>
            <span class="text-[10px] font-bold uppercase tracking-widest">Table</span>
        </button>
        <button onclick="handleMatchNav()" id="nav-match" class="nav-btn flex flex-col items-center gap-1 text-slate-400">
            <span class="text-xl">‚öΩ</span>
            <span class="text-[10px] font-bold uppercase tracking-widest">Match</span>
        </button>
    </nav>

    <!-- TUTORIAL POPUP -->
    <div id="tutorial-modal" class="fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-6 view-hidden">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-3xl p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-2xl font-black italic uppercase tracking-tighter text-red-500 mb-6 text-center border-b border-slate-800 pb-2">Technical Briefing</h3>
            
            <div class="space-y-6 text-sm text-slate-300">
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-lg bg-red-600 flex items-center justify-center shrink-0 font-bold shadow-lg text-white">1</div>
                    <p><span class="text-white font-bold">Match Prep:</span> Match tiles to build stats. Liverpool's performance is driven by these numbers.</p>
                </div>

                <div class="bg-slate-800/40 p-4 rounded-2xl border border-white/5 space-y-2">
                    <p class="text-xs font-black uppercase text-slate-400 tracking-widest mb-1">Statistical Impact</p>
                    <ul class="space-y-1.5 text-[12px]">
                        <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500"></span> <span class="text-red-400 font-bold uppercase">Attack:</span> Higher chance to score.</li>
                        <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500"></span> <span class="text-green-400 font-bold uppercase">Pass:</span> Win the midfield battle.</li>
                        <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span> <span class="text-blue-400 font-bold uppercase">Defense:</span> Stop opponent goals.</li>
                        <li class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-yellow-500"></span> <span class="text-yellow-400 font-bold uppercase">Stamina:</span> Multiplies all other stats.</li>
                    </ul>
                </div>
                
                <div class="bg-slate-800/40 p-4 rounded-2xl border border-white/5 space-y-3">
                    <p class="text-xs font-black uppercase text-blue-400 tracking-widest">Tactical Boosters</p>
                    <div class="flex gap-3 items-center">
                        <div class="w-8 h-8 bg-slate-700 rounded-lg flex items-center justify-center border border-white/20 text-xs shadow-inner">üöÄ</div>
                        <div class="flex-1">
                            <p class="text-white font-bold text-[11px] uppercase">Rocket Ball (Match 4)</p>
                            <p class="text-[10px] text-slate-400">Clears the entire row and column.</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-center pt-1">
                        <div class="w-8 h-8 bg-yellow-600 rounded-full flex items-center justify-center border border-yellow-400 text-xs shadow-lg shadow-yellow-900/20">‚≠ê</div>
                        <div class="flex-1">
                            <p class="text-yellow-400 font-bold text-[11px] uppercase">Star Boost (Match 5+)</p>
                            <p class="text-[10px] text-slate-400">Clears every tile of that color.</p>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-lg bg-red-600 flex items-center justify-center shrink-0 font-bold shadow-lg text-white">2</div>
                    <p><span class="text-white font-bold">The Match:</span> Simulation compares your stats vs the opponent in midfield and attack duels.</p>
                </div>
            </div>

            <button onclick="closeTutorial()" class="mt-8 w-full bg-red-600 text-white py-4 rounded-xl font-black uppercase tracking-widest hover:bg-red-500 transition-all shadow-lg active:scale-95">Up the Reds!</button>
        </div>
    </div>

    <script>
        // LEAGUE DATA
        const teamNames = ["Liverpool FC", "Manchester City", "Arsenal FC", "Aston Villa", "Tottenham Hotspur", "Chelsea FC", "Newcastle United", "Manchester United", "West Ham United", "Brighton"];
        let teams = teamNames.map((name, i) => ({
            id: i,
            name: name,
            mp: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, pts: 0,
            ovr: i === 0 ? 65 : 45 + Math.floor(Math.random() * 35),
            isPlayer: i === 0
        }));

        let currentRound = 1;
        const totalRounds = 18;
        let schedule = [];
        let tutorialShown = false;
        let gamePhase = 'standings'; // 'standings', 'prep', 'sim'

        const boardEl = document.getElementById('board');
        const simLogs = document.getElementById('sim-logs');

        const TYPES = ['attack', 'defense', 'pass', 'stamina'];
        const GRID_SIZE = 7;
        let board = [];
        let tileElements = [];
        let moves = 15;
        let selectedTile = null;
        let isAnimating = false;
        let stats = { attack: 10, defense: 10, pass: 10, stamina: 10 };
        let currentOpponent = null;

        // --- SCHEDULING (Proper Round Robin Circle Method) ---
        function generateSchedule() {
            const numTeams = teams.length;
            const teamPool = teams.map(t => t.id);
            const rounds = numTeams - 1;

            // First Half
            for (let r = 0; r < rounds; r++) {
                const roundMatches = [];
                for (let i = 0; i < numTeams / 2; i++) {
                    const home = teams[teamPool[i]];
                    const away = teams[teamPool[numTeams - 1 - i]];
                    roundMatches.push({ home, away });
                }
                schedule.push(roundMatches);
                // Rotate pool (keep index 0 fixed)
                teamPool.splice(1, 0, teamPool.pop());
            }

            // Second Half (Reverse fixtures)
            const secondHalf = schedule.map(round => round.map(match => ({ home: match.away, away: match.home })));
            schedule = schedule.concat(secondHalf);
        }

        // --- NAVIGATION ---
        function switchView(viewId) {
            ['view-standings', 'view-puzzle', 'view-sim'].forEach(id => {
                document.getElementById(id).classList.add('view-hidden');
            });
            document.getElementById(viewId).classList.remove('view-hidden');
            
            document.getElementById('nav-standings').classList.remove('active', 'text-red-500');
            document.getElementById('nav-match').classList.remove('active', 'text-red-500');
            document.getElementById('nav-standings').classList.add('text-slate-400');
            document.getElementById('nav-match').classList.add('text-slate-400');

            if (viewId === 'view-standings') {
                document.getElementById('nav-standings').classList.add('active', 'text-red-500');
                document.getElementById('nav-standings').classList.remove('text-slate-400');
                gamePhase = 'standings';
            } else {
                document.getElementById('nav-match').classList.add('active', 'text-red-500');
                document.getElementById('nav-match').classList.remove('text-slate-400');
                gamePhase = viewId === 'view-puzzle' ? 'prep' : 'sim';
            }
        }

        function handleMatchNav() {
            if (gamePhase === 'standings') {
                if (currentRound > totalRounds) return alert("Season Finished!");
                startMatchPreparation();
            } else if (gamePhase === 'sim') {
                switchView('view-sim');
            } else {
                switchView('view-puzzle');
            }
        }

        function startMatchPreparation() {
            if (currentRound > totalRounds) return;
            const playerMatch = schedule[currentRound - 1].find(m => m.home.isPlayer || m.away.isPlayer);
            currentOpponent = playerMatch.home.isPlayer ? playerMatch.away : playerMatch.home;
            document.getElementById('puzzle-opp-name').innerText = currentOpponent.name;
            moves = 15; stats = { attack: 10, defense: 10, pass: 10, stamina: 10 };
            updateUI(); createBoard();
            switchView('view-puzzle');
            if (!tutorialShown) { showTutorial(); tutorialShown = true; }
        }

        function updateStandingsUI() {
            const list = document.getElementById('standings-list');
            if (!list) return;
            list.innerHTML = '';
            const sorted = [...teams].sort((a, b) => b.pts - a.pts || (b.gf - b.ga) - (a.gf - a.ga) || b.gf - a.gf);
            sorted.forEach((team, i) => {
                const el = document.createElement('div');
                el.className = `grid grid-cols-9 gap-1 p-3 border-b border-white/5 text-[10px] items-center ${team.isPlayer ? 'bg-red-600/10' : ''}`;
                el.innerHTML = `
                    <div class="col-span-1 font-bold ${i < 1 ? 'text-yellow-400' : 'text-slate-500'}">${i + 1}</div>
                    <div class="col-span-3 font-bold ${team.isPlayer ? 'text-red-500' : ''}">${team.name}</div>
                    <div class="col-span-1 text-center font-mono text-slate-400">${team.mp}</div>
                    <div class="col-span-1 text-center font-mono">${team.w}</div>
                    <div class="col-span-1 text-center font-mono">${team.d}</div>
                    <div class="col-span-1 text-center font-mono">${team.gf - team.ga}</div>
                    <div class="col-span-1 text-center font-black">${team.pts}</div>
                `;
                list.appendChild(el);
            });
            document.getElementById('league-round-display').innerText = `Round ${currentRound} / ${totalRounds}`;
            
            if (currentRound <= totalRounds) {
                const playerMatch = schedule[currentRound - 1].find(m => m.home.isPlayer || m.away.isPlayer);
                const nextOpp = playerMatch.home.isPlayer ? playerMatch.away : playerMatch.home;
                document.getElementById('next-opp-label').innerText = nextOpp.name;
            }
        }

        // --- PUZZLE LOGIC ---
        function updateUI() {
            document.getElementById('moves-count').innerText = moves;
            document.getElementById('hero-atk').innerText = Math.floor(stats.attack);
            document.getElementById('hero-mid').innerText = Math.floor(stats.pass);
            document.getElementById('hero-def').innerText = Math.floor(stats.defense);
            document.getElementById('hero-stam').innerText = Math.floor(stats.stamina);
            document.getElementById('bar-attack').style.width = Math.min(stats.attack, 100) + "%";
            document.getElementById('bar-pass').style.width = Math.min(stats.pass, 100) + "%";
            document.getElementById('bar-defense').style.width = Math.min(stats.defense, 100) + "%";
            document.getElementById('bar-stamina').style.width = Math.min(stats.stamina, 100) + "%";
        }

        function spawnStatIndicator(type, amount) {
            const card = document.getElementById("card-" + type);
            if (!card) return;
            const indicator = document.createElement('div');
            indicator.className = "stat-indicator text-" + type;
            indicator.innerText = "+" + amount;
            card.appendChild(indicator);
            setTimeout(() => indicator.remove(), 1000);
        }

        function createTileElement(r, c, type, booster = null) {
            const el = document.createElement('div');
            el.className = "tile" + (booster ? " booster-" + booster : "");
            const inner = document.createElement('div');
            inner.className = "tile-inner bg-" + type;
            if (booster === 'rocket') inner.innerHTML = 'üöÄ';
            if (booster === 'bomb') inner.innerHTML = '‚≠ê';
            el.appendChild(inner);
            el.onclick = () => !isAnimating && handleTileClick(parseInt(el.dataset.r), parseInt(el.dataset.c));
            updateTilePosition(el, r, c);
            boardEl.appendChild(el);
            return el;
        }

        function updateTilePosition(el, r, c) {
            if (!el) return;
            const step = 100 / GRID_SIZE;
            el.style.top = (r * step) + "%";
            el.style.left = (c * step) + "%";
            el.dataset.r = r;
            el.dataset.c = c;
        }

        function createBoard() {
            if (!boardEl) return;
            board = []; tileElements = []; boardEl.innerHTML = '';
            for (let r = 0; r < GRID_SIZE; r++) {
                board[r] = []; tileElements[r] = [];
                for (let c = 0; c < GRID_SIZE; c++) {
                    let type;
                    do { type = TYPES[Math.floor(Math.random() * TYPES.length)]; } 
                    while ((r >= 2 && board[r-1][c]?.type === type && board[r-2][c]?.type === type) || (c >= 2 && board[r][c-1]?.type === type && board[r][c-2]?.type === type));
                    board[r][c] = { type, booster: null };
                    tileElements[r][c] = createTileElement(r, c, type);
                }
            }
        }

        async function handleTileClick(r, c) {
            if (selectedTile === null) {
                selectedTile = { r, c };
                tileElements[r][c].classList.add('selected');
            } else {
                const prev = selectedTile;
                tileElements[prev.r][prev.c].classList.remove('selected');
                selectedTile = null;
                const dist = Math.abs(prev.r - r) + Math.abs(prev.c - c);
                if (dist === 1) {
                    isAnimating = true;
                    moves--; updateUI();
                    await swapTiles(prev.r, prev.c, r, c);
                    const matched = await checkMatches(r, c);
                    if (!matched) await swapTiles(r, c, prev.r, prev.c);
                    isAnimating = false;
                    if (moves <= 0) triggerMatchTransition();
                }
            }
        }

        async function swapTiles(r1, c1, r2, c2) {
            const t1 = board[r1][c1], t2 = board[r2][c2];
            board[r1][c1] = t2; board[r2][c2] = t1;
            const e1 = tileElements[r1][c1], e2 = tileElements[r2][c2];
            tileElements[r1][c1] = e2; tileElements[r2][c2] = e1;
            updateTilePosition(e1, r2, c2); updateTilePosition(e2, r1, c1);
            await new Promise(r => setTimeout(r, 200));
        }

        async function checkMatches(triggerR, triggerC) {
            let matches = new Set();
            for(let r=0; r<GRID_SIZE; r++) {
                for(let c=0; c<GRID_SIZE-2; c++) {
                    let t = board[r][c]?.type;
                    if(t && board[r][c+1]?.type === t && board[r][c+2]?.type === t) {
                        matches.add(r+","+c); matches.add(r+","+(c+1)); matches.add(r+","+(c+2));
                    }
                }
            }
            for(let c=0; c<GRID_SIZE; c++) {
                for(let r=0; r<GRID_SIZE-2; r++) {
                    let t = board[r][c]?.type;
                    if(t && board[r+1][c]?.type === t && board[r+2][c]?.type === t) {
                        matches.add(r+","+c); matches.add((r+1)+","+c); matches.add((r+2)+","+c);
                    }
                }
            }
            if(matches.size === 0) return false;
            if(matches.size === 4 && triggerR !== -1 && board[triggerR] && board[triggerR][triggerC]) board[triggerR][triggerC].nextBooster = 'rocket';
            if(matches.size >= 5 && triggerR !== -1 && board[triggerR] && board[triggerR][triggerC]) board[triggerR][triggerC].nextBooster = 'bomb';
            const scoreGains = { attack: 0, defense: 0, pass: 0, stamina: 0 };
            matches.forEach(m => {
                const [r, c] = m.split(',').map(Number);
                const tile = board[r][c];
                if(tile) {
                    scoreGains[tile.type]++;
                    if(tile.booster === 'rocket') {
                        for(let i=0; i<GRID_SIZE; i++) {
                            if(board[r][i]) { matches.add(r+","+i); scoreGains[board[r][i].type]++; }
                            if(board[i][c]) { matches.add(i+","+c); scoreGains[board[i][c].type]++; }
                        }
                    } else if (tile.booster === 'bomb') {
                        const targetColor = tile.type;
                        for(let i=0; i<GRID_SIZE; i++) {
                            for(let j=0; j<GRID_SIZE; j++) {
                                if(board[i][j]?.type === targetColor) { matches.add(i+","+j); scoreGains[targetColor]++; }
                            }
                        }
                    }
                }
            });
            for(let type in scoreGains) { if(scoreGains[type] > 0) { stats[type] += scoreGains[type] * 2; spawnStatIndicator(type, scoreGains[type] * 2); } }
            matches.forEach(m => { const [r, c] = m.split(',').map(Number); if(tileElements[r][c]) tileElements[r][c].style.opacity = '0'; });
            await new Promise(r => setTimeout(r, 200));
            matches.forEach(m => {
                const [r, c] = m.split(',').map(Number);
                const nextB = board[r][c]?.nextBooster;
                const type = board[r][c]?.type;
                if(tileElements[r][c]) tileElements[r][c].remove();
                if(nextB) { board[r][c] = { type, booster: nextB }; tileElements[r][c] = createTileElement(r, c, type, nextB); }
                else { board[r][c] = null; tileElements[r][c] = null; }
            });
            updateUI(); await applyGravity(); await checkMatches(-1, -1);
            return true;
        }

        async function applyGravity() {
            for (let c = 0; c < GRID_SIZE; c++) {
                let empty = 0;
                for (let r = GRID_SIZE - 1; r >= 0; r--) {
                    if (board[r][c] === null) empty++;
                    else if (empty > 0) {
                        board[r+empty][c] = board[r][c]; tileElements[r+empty][c] = tileElements[r][c];
                        board[r][c] = null; tileElements[r][c] = null;
                        updateTilePosition(tileElements[r+empty][c], r+empty, c);
                    }
                }
                for (let i = 0; i < empty; i++) {
                    const r = empty - 1 - i; const type = TYPES[Math.floor(Math.random() * TYPES.length)];
                    board[r][c] = { type, booster: null };
                    tileElements[r][c] = createTileElement(-1-i, c, type);
                    setTimeout(() => updateTilePosition(tileElements[r][c], r, c), 50);
                }
            }
            await new Promise(r => setTimeout(r, 300));
        }

        // --- TRANSITION ---
        function triggerMatchTransition() {
            const overlay = document.getElementById('transition-overlay');
            overlay.classList.add('active');
            setTimeout(() => {
                startSimulation();
                setTimeout(() => overlay.classList.remove('active'), 500);
            }, 600);
        }

        // --- SIMULATION ---
        async function startSimulation() {
            switchView('view-sim');
            if (simLogs) simLogs.innerHTML = '';
            const homeScoreEl = document.getElementById('score-home');
            const awayScoreEl = document.getElementById('score-away');
            const finishBtn = document.getElementById('finish-match-btn');
            const initialsEl = document.getElementById('opp-initials');
            if (homeScoreEl) homeScoreEl.innerText = '0';
            if (awayScoreEl) awayScoreEl.innerText = '0';
            if (finishBtn) finishBtn.classList.add('view-hidden');
            const playerMatch = schedule[currentRound - 1].find(m => m.home.isPlayer || m.away.isPlayer);
            const isHome = playerMatch.home.isPlayer;
            const oppTeam = currentOpponent;
            if (initialsEl) initialsEl.innerText = oppTeam.name.substring(0, 3).toUpperCase();
            const stamMult = 0.5 + (stats.stamina / 50);
            const pStats = { atk: stats.attack * stamMult, def: stats.defense * stamMult, pass: stats.pass * stamMult };
            let pGoals = 0, oGoals = 0;
            const segments = [10, 20, 35, 45, 55, 70, 80, 90]; 
            for(let min of segments) {
                if (simLogs) {
                    const eventContainer = document.createElement('div');
                    eventContainer.className = "p-3 bg-slate-900 border border-slate-800 rounded-2xl space-y-3 shadow-lg";
                    eventContainer.innerHTML = `<div class="flex items-center gap-2 border-b border-slate-800 pb-2"><span class="bg-red-600 px-1.5 py-0.5 rounded text-[10px] font-black italic shadow-md text-white">${min}'</span><span class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">Match Breakdown</span></div>`;
                    simLogs.appendChild(eventContainer);
                    await new Promise(r => setTimeout(r, 1500)); 
                    const pPassRoll = Math.floor(Math.random() * pStats.pass);
                    const oPassRoll = Math.floor(Math.random() * oppTeam.ovr);
                    const playerAtks = pPassRoll >= oPassRoll;
                    const midfieldUI = document.createElement('div'); midfieldUI.className = "space-y-3";
                    midfieldUI.innerHTML = `<div class="flex flex-col gap-1 w-full"><div class="flex justify-between px-1 text-[9px] uppercase font-black"><span class="text-slate-400">Midfield Duel</span><span class="${playerAtks ? 'text-red-500' : 'text-blue-500'}">${playerAtks ? 'LFC Possession' : oppTeam.name.split(' ')[0] + ' Ball'}</span></div><div class="flex items-center gap-2"><span class="font-mono text-red-500 font-black text-xs">${pPassRoll}</span><div class="flex-1 h-1.5 bg-slate-800 rounded-full overflow-hidden flex"><div class="bg-red-600 h-full transition-all duration-1000" style="width: ${Math.min((pPassRoll/(pPassRoll+oPassRoll+1))*100, 100)}%"></div><div class="bg-blue-600 h-full transition-all duration-1000" style="width: ${Math.min((oPassRoll/(pPassRoll+oPassRoll+1))*100, 100)}%"></div></div><span class="font-mono text-blue-500 font-black text-xs">${oPassRoll}</span></div></div>`;
                    eventContainer.appendChild(midfieldUI);
                    await new Promise(r => setTimeout(r, 1800)); 
                    let goal = false, outcomeTitle = "", narrative = "", atkVal = 0, defVal = 0;
                    if(playerAtks) {
                        atkVal = Math.floor(Math.random() * pStats.atk); defVal = Math.floor(Math.random() * (oppTeam.ovr + 5));
                        if(atkVal > defVal + 15) { goal = true; pGoals++; outcomeTitle = "Goal!"; narrative = "Liverpool slices through the backline!"; }
                        else if (atkVal > defVal) { outcomeTitle = "Save"; narrative = "The keeper tips it away."; }
                        else { outcomeTitle = "Blocked"; narrative = "Opposition defense regroups."; }
                    } else {
                        atkVal = Math.floor(Math.random() * oppTeam.ovr); defVal = Math.floor(Math.random() * pStats.def);
                        if(atkVal > defVal + 15) { goal = true; oGoals++; outcomeTitle = "Goal Conceded"; narrative = oppTeam.name + " finds a pocket of space!"; }
                        else if (atkVal > defVal) { outcomeTitle = "Close"; narrative = "The ball rattles the post!"; }
                        else { outcomeTitle = "Intercepted"; narrative = "LFC defense halts the break."; }
                    }
                    const outcomeUI = document.createElement('div'); outcomeUI.className = "p-2 bg-slate-800/40 rounded-xl border border-slate-700/30 space-y-2";
                    outcomeUI.innerHTML = `<div class="flex justify-between items-center px-1"><span class="text-[9px] text-slate-500 uppercase font-black">${playerAtks ? 'LFC Attack' : 'Defending'}</span><span class="${goal ? 'text-green-400' : 'text-white'} font-black text-[10px] italic uppercase tracking-tighter">${outcomeTitle}</span></div><div class="flex items-center gap-2"><span class="font-mono text-[10px] font-black ${playerAtks ? 'text-red-500' : 'text-blue-500'}">${atkVal}</span><div class="flex-1 h-1 bg-slate-800 rounded-full overflow-hidden flex"><div class="${playerAtks ? 'bg-red-500' : 'bg-blue-500'} h-full transition-all" style="width: ${Math.min((atkVal/(atkVal+defVal+1))*100, 100)}%"></div><div class="${playerAtks ? 'bg-blue-500' : 'bg-red-500'} h-full transition-all" style="width: ${Math.min((defVal/(atkVal+defVal+1))*100, 100)}%"></div></div><span class="font-mono text-[10px] font-black ${playerAtks ? 'text-blue-500' : 'text-red-500'}">${defVal}</span></div><div class="text-[10px] text-slate-400 italic">${narrative}</div>`;
                    eventContainer.appendChild(outcomeUI);
                    if (homeScoreEl) homeScoreEl.innerText = isHome ? pGoals : oGoals;
                    if (awayScoreEl) awayScoreEl.innerText = isHome ? oGoals : pGoals;
                    if(goal) { const sp = isHome ? homeScoreEl : awayScoreEl; sp.classList.add('goal-anim'); setTimeout(() => sp.classList.remove('goal-anim'), 600); }
                    simLogs.scrollTop = simLogs.scrollHeight;
                    await new Promise(r => setTimeout(r, 1200));
                }
            }
            const playerTeam = teams[0];
            updateTeamStats(playerTeam, pGoals, oGoals); updateTeamStats(oppTeam, oGoals, pGoals);
            schedule[currentRound-1].forEach(m => {
                if(!m.home.isPlayer && !m.away.isPlayer) {
                    const hG = Math.floor(Math.random() * (m.home.ovr / 15)), aG = Math.floor(Math.random() * (m.away.ovr / 15));
                    updateTeamStats(m.home, hG, aG); updateTeamStats(m.away, aG, hG);
                }
            });
            currentRound++;
            if (finishBtn) { finishBtn.classList.remove('view-hidden'); finishBtn.onclick = () => { updateStandingsUI(); switchView('view-standings'); }; }
        }

        function updateTeamStats(team, gf, ga) {
            team.mp++; team.gf += gf; team.ga += ga;
            if(gf > ga) { team.w++; team.pts += 3; }
            else if(gf === ga) { team.d++; team.pts += 1; }
            else { team.l++; }
        }

        function showTutorial() { document.getElementById('tutorial-modal').classList.remove('view-hidden'); }
        function closeTutorial() { document.getElementById('tutorial-modal').classList.add('view-hidden'); }

        window.onload = () => { generateSchedule(); updateStandingsUI(); };
    </script>
</body>
</html>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC2RSC711FagoP5XsODIFfLMMZUX6Up-xM",
        authDomain: "prototypes-7691b.firebaseapp.com",
        projectId: "prototypes-7691b",
        storageBucket: "prototypes-7691b.firebasestorage.app",
        messagingSenderId: "263652926534",
        appId: "1:263652926534:web:9af3c4ce63aab78f0f9647",
        measurementId: "G-1X91H99N2G"
    };

    let db;
    let auth;
    let currentUser = null;
    let timePlayed = 0;
    const gameId = "football-legendary-league";

    async function initFirebase() {
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                try {
                    await setPersistence(auth, inMemoryPersistence);
                } catch (e) {
                    console.warn("Persistence fallback warning:", e);
                }

                const userCredential = await signInAnonymously(auth);
                currentUser = userCredential.user;
                console.log("Firebase Initialized & Signed In: " + currentUser.uid);
                
                setInterval(() => {
                    timePlayed++;
                }, 1000);
            }
        } catch (e) {
            console.error("Firebase Error:", e);
        }
    }

    async function updateTimePlayed() {
        if (db && currentUser && timePlayed > 0) {
            try {
                const statsRef = doc(db, "game_stats", gameId);
                await updateDoc(statsRef, {
                    timePlayed: increment(timePlayed)
                });
            } catch (e) {
                console.error("Error updating time played", e);
            }
        }
    }

    window.addEventListener('beforeunload', updateTimePlayed);
    
    initFirebase();
</script>